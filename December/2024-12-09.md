# 2024-12-09

# :sunglasses: Today I Learned

## Docker 

## Docker 사용 이유
- 일관성
- 이식성
- 효율성
- 확장성

## 간단 용어 정리
- 컨테이너
    - 어플리케이션과 그 실행에 필요한 모든 것을 포함한 패키지
    - 소프트웨어가 실행되는 독립적인 환경
- 이미지
    - 컨테이너를 생성하는데 사용되는 템플릿. 설계도
    - 이미지에는 어플리케이션과 필요한 라이브러리, 설정 파일 등이 포함
- 도커파일
    - 이미지를 생성하기 위한 설정 파일, 일련의 명령어들이 포함
    - `Dockerfile` 이라는 문서는 약속 된 파일명임, 이 이름으로 파일명을 만들면 도커 실행 시 자동으로 읽음

## Dockerfile의 기본 문법
- `FROM` : 베이스 이미지를 지정
- `RUN` : 컨테이너 내에서 명령어를 실행
- `CMD` : 컨테이너가 시작될 때 실행할 명령어를 지정
- `COPY` : **파일을 로컬에서 이미지로 복사**
- `WORKDIR`
    - 컨테이너 내에서 위치할 기본 디렉토리를 지정
    - 이후의 모든 `RUN`, `CMD`, `ENTRYPOINT`, `COPY`,`ADD` 명령어는 **이 디렉토리를 기준으로 실행**됨
    - 디렉토리가 존재하지 않으면 **자동으로 생성**되며 절대경로나 상대경로 모두 사용 가능함

## 문법들의 특징 알아보자
### CMD
- Exec 형식
```docker
CMD command param1 param2
```
- 셸 형식
```docker
CMD ["executable", "param1", "param2"]
```
- Dockerfile에서 CMD는 하나임
    - 여러 CMD가 존재한다면 **마지막 CMD**만 유효함
- 컨테이너 실행 시 명령을 직접 지정하면 Dockerfile에서 지정한 CMD는 무시됨
- CMD는 이미지 빌드 시점이 아닌 **컨테이너 실행 시점**에 동작함

### ENTRYPOINT
```docker
ENTRYPOINT ["curl", "https://jsonplaceholder.typicode.com/todos"]
```
- 컨테이너가 시작될 때마다 `curl http://example.com` 명령어가 실행되도록 설정

### ENTRYPOINT와 CMD의 차이점
- **CMD**
    - 기본 명령을 지정하되, 필요 시 쉽게 오버라이딩 가능
- **ENTRYPOINT**
    - 컨테이너 시작 시 반드시 실행해야 하는 명령을 지정
    - CMD와 ENTRYPOINT가 같이 작성된 경우 **CMD는 ENTRYPOINT에 인자로 제공됨**

### RUN
- 현재 이미지 위에 새 레이어를 생성하고 그 안에서 명령을 실행
- 주로 **패키지 설치, 파일 생성, 권한 변경** 등의 작업 수행
    - Exec 형식, 셸 형식 가능
- 이미지 빌드 시점에 실행 됨
- 명령 실행 결과가 이미지에 **커밋** 됨

### COPY
- “. .”란
    - 첫번 째 “.” : 로컬에서 **Dockerfile이 위치한 현재 디렉토리**를 의미
    - 두번 째 “.” : **컨테이너 내부의 현재 작업 디렉토리**를 의미 (WORKDIR)

### Docker Multi Stage Build *(*멀티 스테이지 빌드)
- Dockerfile에서 **하나의 컨테이너 이미지 빌드를 여러 단계로 나누어 관리**하는 방법

- 사용법
    - `Dockerfile`에 여러 개의 `FROM` 명령어를 사용하여 각 단계를 정의하면 됨
    - **각 `FROM` 명령어는 서로 다른 베이스 이미지로 새로운 빌드 단계를 시작하며, 한 단계에서 다른 단계로 필요한 결과물만 선택적으로 복사할 수 있음**
        - 이를 통해 최종 이미지에서 불필요한 요소들을 제외할 수 있음
    - `Dockerfile`은 주로 두 단계로 구성됨
        - 첫 번째 단계에서는 바이너리를 빌드하고
        - 두 번째 단계에서는 빌드된 바이너리만 복사함
    - 이 모든 과정은 하나의 `Dockerfile` 만 사용하면 됨
        - 따라서 별도의 빌드 추가적인 스크립트나 플러그인 없이 `Dockerfile` 하나와 `docker build` 명령어만 있으면 멀티스테이징을 진행할 수 있음
